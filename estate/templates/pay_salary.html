{% extends "base.html" %}
{% load currency %}
{% block title %}Pay Salary{% endblock %}

{% block content %}
<div class="dashboard-card" style="max-width: 600px; margin: auto;">

 <h2 class="dashboard-title mb-4">
  Pay Salary
 </h2>

 <div class="mb-3 p-3 rounded" style="background:#f6faf6;">
  <p class="mb-1">
   <strong>Employee:</strong> {{ employee.name }}
  </p>

  {% if employee.role %}
  <p class="mb-1">
   <strong>Role:</strong> {{ employee.role }}
  </p>
  {% endif %}

  <p class="mb-1">
   <strong>Salary For:</strong>
   <span id="salaryForLabel">
    {{ selected_month_label|default:"Not selected" }}
   </span>
  </p>

  <p class="mb-0">
   <strong>Salary Amount:</strong>
   {% if salary_amount is not None %}
   {{ salary_amount|ugx }}
   {% else %}
   <span class="text-muted">Not configured</span>
   {% endif %}
  </p>
 </div>

 <form method="post">
  {% csrf_token %}

  <div class="mb-3">
   <label class="form-label">Salary For Month</label>

   <!-- Display input -->
   <input type="text" id="salaryMonthDisplay" class="form-control" placeholder="Select month..." readonly>

   <!-- Actual value sent to backend -->
   <input type="hidden" id="salaryMonth" name="month" value="{{ default_month }}" required>

   <small class="text-muted">
    Salary will be recorded for this month (non-retroactive).
   </small>
  </div>

  <div class="mb-4">
   <label class="form-label">Date Paid</label>
   <input type="date" name="date_paid" class="form-control" required>
  </div>

  <div class="d-flex gap-3">
   <button type="submit" class="btn btn-main">
    Pay Salary
   </button>

   <a href="{% url 'expenses_ledger' %}" class="btn btn-outline-main">
    Cancel
   </a>
  </div>

 </form>
</div>

<hr class="my-4">

<div class="dashboard-card" style="max-width: 600px; margin: auto;">
 <h5 class="mb-3">Schedule Salary Change (Raise)</h5>

 <p class="text-muted mb-3">
  Salary changes are non-retroactive and apply from the selected month forward.
 </p>

 <form method="post" action="{% url 'change_salary' employee.id %}">
  {% csrf_token %}

  <div class="row g-3">
   <div class="col-md-6">
    <label class="form-label">New Monthly Salary</label>
    <input type="number" name="new_salary" class="form-control" step="0.01" min="0.01" required>
   </div>

   <div class="col-md-6">
    <label class="form-label">Effective Month</label>
    <input type="month" name="effective_month" class="form-control" required>
   </div>
  </div>

  <div class="mt-3">
   <button type="submit" class="btn btn-outline-main">
    Save Salary Change
   </button>
  </div>
 </form>
</div>
{% endblock %}

{% block scripts %}
<script>
 flatpickr("#salaryMonthDisplay", {
  plugins: [
   new monthSelectPlugin({
    shorthand: false,
    dateFormat: "Y-m",
    altFormat: "F Y"
   })
  ],
  defaultDate: "{{ default_month }}",
  onReady: function (selectedDates, dateStr, instance) {
   if (selectedDates.length) {
    instance.input.value = instance.formatDate(selectedDates[0], "F Y");
    document.getElementById("salaryMonth").value = dateStr;

    const label = document.getElementById("salaryForLabel");
    if (label) {
     label.textContent = instance.formatDate(selectedDates[0], "F Y");
    }
   }
  },
  onChange: function (selectedDates, dateStr, instance) {
   document.getElementById("salaryMonth").value = dateStr;
   instance.input.value = instance.formatDate(selectedDates[0], "F Y");

   const label = document.getElementById("salaryForLabel");
   if (label) {
    label.textContent = instance.formatDate(selectedDates[0], "F Y");
   }

   // Reload so backend recomputes salary for the selected month
   const url = new URL(window.location.href);
   url.searchParams.set("month", dateStr);
   window.location.href = url.toString();
  }
 });
</script>
{% endblock %}